# Results

```{r}
library(ggmap)
library(parcoords)
library(GGally)
library(leaflet)
library(lubridate)
library(vcd)
library(vcdExtra)
library(RColorBrewer)
library(tidyverse)
```

## Events and Parks Analysis


```{r}
top_categories <- nyc_event_categories %>%
  group_by(Cat) %>%
  summarize(count = n()) %>%
  arrange(desc(count)) %>%
  top_n(30)

top_categories_levels <- levels(fct_reorder(top_categories$Cat, top_categories$count))

top_locations <- nyc_event_listing_locations %>%
  group_by(LcNm) %>%
  summarize(count = n()) %>%
  arrange(desc(count)) %>%
  top_n(30)

```


### Most Diversified Park



After seeing that the top event locations are hosting several thousands of events over the years 2013-2019, we 
wonder which of them are the most diverse ones, in the sense that they have a lot of distinct event organizers 
organizing events of different categories in them.

```{r}

nyc_events_left_joined %>%
  drop_na(LcNm, Org, Cat) %>%
  group_by(LcNm) %>%
  summarize(UniqueCats = n_distinct(Cat), UniqueOrgs = n_distinct(Org)) %>%
  ggplot(aes(UniqueOrgs, UniqueCats)) +
  geom_point(alpha = 0.4, size = 2, stroke = 0) +
  geom_text(aes(label = ifelse((UniqueOrgs > 24) | (UniqueCats > 45), as.character(LcNm),'')), 
            size = 2,
            hjust = 0.75, 
            vjust = 0.9) +
  labs(x = "Count of Distinct Organizers", y = "Count of Distinct Event Categories") + 
  ggtitle("Parks Hosting Different Event Categories Organized by Different Event Organizers") + 
  theme(panel.background = element_blank())

```

Surprisingly, the most famous parks like "Central Park" and "Washington Square Park" do not show up. From the 
location names, we realize these parks might be too large and have different sub locations (e.g. "Visitor Center" 
inside of "Conference House Park") listed as the location name in the datasets we have. We then again plot the 
scatterplot using `PkId`:

```{r}
parks_pkid_diversity <- nyc_events_left_joined %>%
  drop_na(PkId, Org, Cat) %>%
  group_by(PkId) %>%
  summarize(UniqueCats = n_distinct(Cat), UniqueOrgs = n_distinct(Org))

ggplot(parks_pkid_diversity, aes(UniqueOrgs, UniqueCats)) +
  geom_point(alpha = 0.4, size = 2, stroke = 0) +
  geom_text(aes(label = ifelse((UniqueOrgs > 40) | (UniqueCats > 60), as.character(PkId),'')), 
            size = 3,
            hjust = 1, 
            vjust = 1) +
  labs(x = "Count of Distinct Organizers", y = "Count of Distinct Event Categories") + 
  ggtitle("Parks Hosting Different Event Categories Organized by Different Event Organizers") + 
  theme(panel.background = element_blank())

```

A quick Googling using the longitude and latitude of these park ids tells us that, the labels from left to right are:

* "X039" is "Pelham Bay Park"
* "B073" is "Prospect Park"
* "X104" is "Williamsbridge Oval Skate Park"
* "X092" is "Van Cortlandt Park"
* "X045" is "St. Mary's Park"
* "M029" is "Fort Tryon Park"
* "R006" is "Conference House Park" in Staten Island
* "M098" is "Washington Square Park"
* "M042" is "Inwood Hill Park"
* "Q099" is "Flushing Meadows Corona Park"
* "M010" is "Central Park"

all of which are more well-known parks in NYC.

From this scatter plot, it is certainly apparent that there seems to be a correlation that the parks with more 
diverse groups of organizers choosing them as event locations tend to have events with more diverse categories as 
well, which makes us wonder if different organizers have preferences over certain event categories.

### Organizer Preferences on Categories and Locations

```{r}

nyc_events_left_joined %>%
  drop_na(PkId, Org, Cat) %>%
  group_by(Org) %>%
  summarize(UniqueCats = n_distinct(Cat), UniquePkIds = n_distinct(PkId)) %>%
  ggplot(aes(UniquePkIds, UniqueCats)) +
  geom_point(alpha = 0.4, size = 2, stroke = 0) +
  geom_text(aes(label = ifelse((UniquePkIds > 40) | (UniqueCats > 60), as.character(Org),'')), 
            size = 2,
            hjust = 0, 
            vjust = 0) +
  labs(x = "Count of Distinct Parks", y = "Count of Distinct Event Categories") + 
  ggtitle("Organizers Organizing Different Event Categories Hosted by Different Parks") + 
  theme(panel.background = element_blank())

```


### Cost, Borough, Duration, and Time of Events

```{r}
nyc_event_listing_events %>%
  mutate(Duration=difftime(
    strptime(paste(Dt, ET), "%Y-%m-%d %H:%M"), strptime(paste(Dt, ST), "%Y-%m-%d %H:%M"), units = "hours")) %>%
  filter(Duration > 0) %>%
  ggplot(aes(Duration)) +
  geom_histogram(binwidth=1, color = "blue", fill = "lightblue") +
  ggtitle("Histogram for Event Durations") +
  labs(x = "Event Duration", y = "Count of Events")
```


```{r, fig.width=9, fig.height=9}
get_duration_category <- function(Dt, ST, ET) {
  d <- as.numeric(difftime(strptime(paste(Dt, ET), "%Y-%m-%d %H:%M"), strptime(paste(Dt, ST), "%Y-%m-%d %H:%M")))/3600
  case_when (
    d < 1 ~ "< 1",
    (d >= 1.00 & d < 3.00) ~ "1-3",
    (d >= 3.00 & d < 5.00) ~ "3-5",
    d >= 5.00 ~ ">= 5"
  )
}
get_time_of_day <- function(ST){
  hour = ST %>% map(~ as.numeric(strsplit(.x, ':')[[1]][1]))
  case_when(
   hour >= 0 & hour < 6 ~ "Night",
   hour >= 6 & hour < 12 ~ "Morning",
   hour >= 12 & hour < 18 ~ "Afternoon",
   hour >= 18 & hour <24 ~ "Evening"
 )
}

free_mosaic <- nyc_events_left_joined %>%
  drop_na(Bo, CsFr, Dt, ST, ET) %>%
  mutate(Duration=get_duration_category(Dt, ST, ET),
         TimeofDay=get_time_of_day(ST))

free_mosaic$CostFree = as.factor(ifelse(free_mosaic$CsFr == 0, "Not Free", "Free"))
free_mosaic$Borough = as.factor(free_mosaic$Bo)
free_mosaic$Duration = fct_relevel(free_mosaic$Duration, levels = c("< 1", "1-3", "3-5", ">=5"))
free_mosaic$Time = fct_relevel(free_mosaic$TimeofDay, levels = c("Morning", "Afternoon", "Evening", "Night"))

mosaic_select <- free_mosaic %>%
  select(CostFree, Borough, Duration, Time)

pairs(table(mosaic_select),
      highlighting=2, 
      diag_panel = pairs_diagonal_text(
        distribute = "margin",
        rot = 45)
      )
```



## Timeseries Analysis

Now, it is natural to think that there is some seasonality in the events that happen in the NYC public locations.
Here we are going to perform an analysis on what are some interesting seasonal patterns

### Timeseries Analysis on NYC Parks Events

First, we simply take an overview look at the count of listed events over time:

```{r}
nyc_events_timeseries <- nyc_event_listing_events %>%
  group_by(Dt) %>%
  summarize(Count = n()) %>%
  ungroup()

ggplot(nyc_events_timeseries, aes(Dt, Count)) + 
  geom_line() + 
  labs(x = "Date", y = "Count of Events") +
  ggtitle("Count of NYC Events in Parks Over Time")
```

Here, we observe a few things at first sight:

* The data counts appears to be abnormally low after the start of 2019, probably due to limited data availablility in the dataset, therefore, we are going to only use data prior to 2019 in our following timeseries analysis on the events daata in this section.
* The seasonality pattern looks similar for each year.
* There is definitely fewer events in winters around Janurary and generally more events in the summers.

The previous plot, although helps us identify the general pattern, looks pretty noisy, so next let's take a different view, which is less noisy:

```{r, fig.width=10}
nyc_events_timeseries_weekly <- nyc_event_listing_events %>%
  filter(Dt < as.Date("2019-01-01")) %>%
  mutate(Month = month(Dt, label=TRUE, abbr=TRUE), Wday = wday(Dt, label = TRUE, abbr = TRUE), Year=year(Dt)) %>%
  group_by(Month, Wday, Year) %>%
  summarize(Count = n())
nyc_events_timeseries_weekly
ggplot(nyc_events_timeseries_weekly, aes(Wday, Count)) +
  geom_bar(stat="identity", color = "blue", fill = "lightblue") +
  facet_grid(cols=vars(Month), rows=vars(Year))+
  ylim(0,500) + 
  ggtitle("Weekly Count of Park Events by Month") + 
  labs(x = "Weekday", y = "Count of Events") +
  ggtitle("Count of NYC Events in Parks By Weekday in Each Month") +
  theme(axis.text.x = element_text(angle = 90, vjust = 1, hjust=1))
```

Here, we are aggregating the event counts by month, and plotted bar charts faceted by year. It is very clear from 
these charts that the monthly counts and trends do indeed have a very similar pattern across the years 2013-2018. 
Other than some fluctuations, January through March are typically the more quiet months with fewer than 500 events
in most years, then the number of events gradually increases in April, May and June, and peaks in July or August 
with more than 1500 events, and then gradually decreases into the winter season, with around 500 events in 
December.

Now, how about different days of week? It's certainly natural to speculate that there will be more events over 
weekends than during weekdays. Here, since we have concluded in the previous section that the seasonal trend is 
similar across the years, we take a closer look at the number of listed events by day of week in 2017 
to get an idea.

As expected, Saturdays do typically have a lot more events than the other days, especially during the summer 
season. It is somewhat surprising that Sundays only have about similar number of events as Tuesdays, Wednesdays 
and Thursdays. We speculate that for weekends, people prefer to stay at home with family and prepare for the new 
week on Sundays and prefer to go out to events on Saturdays, and therefore the event organizers have a preference 
to organize events on Saturdays. It is not surprising that Monday have the fewest events since people are 
typically busy on the first business day of the week. Fridays also appear to have the 2nd fewest number of events 
among the different days of week, as people wrap up the work for the week, and usually have corporate events or 
team bonding activities on Fridays.

### Timeseries Analysis on Event Categories

After the initial timeseries analysis, we feel that it's likely that other than the general seasonality and weekly
trends, different event sub-categories could have very different trends. Thus we will take a closer look at the top 30 categories for NYC parks events in this section.

```{r}
nyc_events_categories_timeseries_monthly <- nyc_event_listing_events %>%
  merge(
    y = nyc_event_categories, 
    by = "EvtId", 
    all.x = TRUE) %>%
  filter(Dt < as.Date("2019-01-01")) %>%
  filter(Cat %in% top_categories$Cat) %>%
  mutate(Year = year(Dt), 
         Month = month(Dt, label = TRUE, abbr = TRUE), 
         DoW = wday(Dt, label = TRUE),
         Cat = fct_rev(factor(Cat, levels = top_categories_levels)))
```

First, we look at if there are trends in the numbers of events for different categories over the years.


```{r, fig.height=9}

nyc_events_categories_timeseries_monthly %>%
  group_by(Year, Cat) %>%
  summarize(Count = n()) %>%
  ungroup() %>%
  ggplot(aes(Year, Count)) +
  geom_col(color = "blue", fill = "lightblue") +
  facet_wrap(~Cat, ncol = 4) +
  ggtitle("Yearly Count of Events for top 30 Event Categories in NYC Parks") + 
  labs(x = "Year", y = "Count of Events") + 
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))
```


We can notice on this plot that for most of the top categories, the number of events listed in each year from 2013
to 2018 more or less just fluctuates and stays mostly flat. However, for category "Education", there is a very 
noticeable increase for year 2018, and for categories "Seniors", "Accessible", "Film", "Dance", "Free Summer 
Movies", there appear to be an uptrend, whereas for categories like "Games" and "Birding", there appear to be a 
downtrend.

Next, we look at if all categories follow the general seasonality discussed in the previous section, or there are 
noticeable differences in the different categories.


```{r, fig.height=9}
nyc_events_categories_timeseries_monthly %>%
  group_by(Month, Cat) %>%
  summarize(Count = n()) %>%
  ungroup() %>%
  ggplot(aes(Month, Count)) +
  geom_col(color = "blue", fill = "lightblue") +
  scale_x_discrete(breaks=c("Mar", "Jun", "Sep", "Dec"),) + 
  facet_wrap(~Cat, ncol = 4) +
  ggtitle("Monthly Count of Events for top 30 Event Categories in NYC Parks") + 
  labs(x = "Month", y = "Count of Events") + 
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))
```


Here, we can see that yes, for most of the top 30 categories, they mostly follow the "more events in the summer, 
fewer in the winter" general rule, with some other interesting observations, most noticeably:

* "Nature" events appear to be relatively flat from April through October, which is Spring through Autumn for NYC, then reduces during winter.
* "Arts & Crafts", "Poe Park Visitor Center", "Urban Park Rangers", and "Talks" events look to be relatively flat and just fluctuates throughout the year, with no apparent peaks.
* "Volunteer", "It's My Park" and "City Parks Foundation" events appear to have peaks in May and October.
* "History", "Tours", and "Historic House Trust Sites" events appear to increase from Januray through October, peaks at October, and then decreases in November and December.
* "Birding" has peaks in April and May.

Lastly, we also inspect the day of week pattern of when the top 30 event categories happen.

```{r, fig.height=9}
nyc_events_categories_timeseries_monthly %>%
  group_by(DoW, Cat) %>%
  summarize(Count = n()) %>%
  ungroup() %>%
  ggplot(aes(DoW, Count), color = "blue", fill = "lightblue") +
  geom_col(color = "blue", fill = "lightblue") +
  facet_wrap(~Cat, ncol = 4) +
  ggtitle("Day of Week Count of Events for top 30 Event Categories in NYC Parks") + 
  labs(x = "Day of Week", y = "Count of Events") + 
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))
```

As we can see from this plot, most of the top 30 event categories again follow the general "most events on Saturdays, fewest on Mondays" rule, again with some other interesting observations, most noticeably:

* "Seniors" has fewest events on Sundays and most events on Tuesdays, and relatively about the same count of events for different days of the week.
* "Volunteer", "It's My Park", "Urban Park Rangers", and "Birding" events happen primarily over weekends, and have very few events during weekdays.
* "Accessible", "Sports", and "Games" events happen about the same number of times during different days of the week.
* "Film" and "Free Summer Movies" have peaks on Fridays.
* "City Parks Foundation" events happen more frequently during weekdays than during weekends.
* "Poe Park Visitor Center" events do not occur on Sundays and Mondays.

## Crimes in Parks

Now we take a look at the crimes in the NYC parks recorded by NYPD.

### Crimes in Parks Overview

```{r}
fills7 <- brewer.pal(7, 'Accent')

nyc_parks_crimes_total <- nyc_parks_crime %>%
  group_by(Boro) %>%
  summarize(Mdr = sum(Mdr), 
            Rape = sum(Rape), 
            Rob = sum(Rob), 
            Aslt = sum(Ass), 
            Burg = sum(Burg), 
            GL = sum(G_L), 
            GLM = sum(GL_M_V)) %>%
  pivot_longer(!Boro, names_to = "CrimeType", values_to = "Freq") %>%
  mutate(CrimeType = fct_relevel(CrimeType, "GLM", "Rob", "Rape", "Mdr", after = Inf)) %>%
  mutate(Boro = fct_recode(Boro, 
                           B = "BROOKLYN", 
                           M = "MANHATTAN", 
                           R = "STATEN ISLAND", 
                           Q = "QUEENS", 
                           X = "BRONX", 
                           "B/Q" = "BROOKLYN/QUEENS")) %>%
  mutate(Boro = fct_relevel(Boro, "B/Q"))

vcd::mosaic(CrimeType ~ Boro, 
            nyc_parks_crimes_total, 
            direction = c("v", "h"),
            labeling = labeling_border(tl_labels = c(FALSE, FALSE),
                                       gp_labels = gpar(fontsize = 9),
                                       set_varnames = c(Boro = "Borough", CrimeType = "Crime Type"),
                                       rot_labels = c(0, 0, 0, 0)),
            highlighting_fill = fills7,
            main = "Mosaic Plot of Crime Types in Boroughs of NYC")
```

The distribution of crime types in the different Boroughs of NYC over the years of 2014 through 2021 is actually different, especially around "Grand Larceny" and "Robbery" - for example, Manhattan has more "Grand Larceny" than "Robbery", whereas Staten Island and Bronx both have more "Robbery" than "Grand Larceny".

### Crime Timeseries Analysis
```{r, fig.width=9}
nyc_crimes_timeseries_quarterly <- nyc_parks_crime %>%
  drop_na(Boro, Qtr) %>%
  group_by(Boro, Qtr) %>%
  summarize(Mdr = sum(Mdr), 
            Rape = sum(Rape), 
            Rob = sum(Rob), 
            Aslt = sum(Ass), 
            Burg = sum(Burg), 
            GL = sum(G_L), 
            GLM = sum(GL_M_V),
            Tot = sum(Tot)) %>%
  pivot_longer(cols=3:10, names_to="Crime", values_to="Count")
ggplot(nyc_crimes_timeseries_quarterly, aes(Qtr, Count, group=Boro, color=Boro)) +
  geom_line(size = 0.5) +
  facet_grid(rows=vars(Crime), scales="free_y")+
  ggtitle("Count of Park Crimes by Category") + 
  labs(x = "Quarter", y = "Count of Reports") +
  ggtitle("Count of NYC Park Crimes in Parks By Quarter") +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))
        # axis.text.y = element_text(size = 12),
        # axis.title = element_text(size = 14),
        # strip.text.y = element_text(size = 14),
       
```


### Crimes in parks and events in parks

It is challenging to join the two datasets entirely based on the parks, as they come from two different data sources and do not share identifier keys for the parks. However, it is possible to manually select a few parks from both datasets and inspect the park names and try to match and join the data for those selected parks.

```{r}
top10_parks_most_crime <- nyc_parks_crime %>% 
  group_by(Park) %>%
  summarize(count_of_crimes = sum(Tot)) %>%
  arrange(desc(count_of_crimes)) %>%
  top_n(10)

top10_parks_most_events <- nyc_event_listing_events[c("EvtId")] %>%
  merge(
    y = nyc_event_listing_locations, 
    by = "EvtId", 
    all.x = TRUE) %>%
  drop_na(PkId) %>%
  group_by(PkId) %>%
  summarize(count_of_events = n()) %>%
  arrange(desc(count_of_events)) %>%
  top_n(10)

knitr::kable(
  list(top10_parks_most_crime, top10_parks_most_events),
  booktabs = TRUE,
  caption = 'Parks with most crimes and Parks with most events'
)
```

A quick data aggregation gives us the top 10 parks with most crimes and top 10 parks with the most events, as shown in the data table above. However, we discovered that somehow the crimes data do not have any records for crimes in "Central Park" (M010). Together with our interests of the most diverse parks as analyzed in the [Most Diversified Park] section, we will select the following parks to analyze, and use this manually created mapping as the helper table to join our data:

```{r}

park_crime_event_mapping <- tibble(
  PkId = c(
    "Q099",
    "B169",
    "M104",
    "M098",
    "B073",
    "M072",
    "M089",
    "X010",
    "M008",
    "X002",
    "X040",
    "X209",
    "R006",
    "B431",
    "M029",
    "X092",
    "X039",
    "X104",
    "X045",
    "M042"
  ),
  Park = c(
    "FLUSHING MEADOWS CORONA PARK",
    "CONEY ISLAND BEACH & BOARDWALK",
    "RANDALL'S ISLAND PARK",
    "WASHINGTON SQUARE PARK",
    "PROSPECT PARK",
    "RIVERSIDE PARK",
    "UNION SQUARE PARK",
    "CROTONA PARK",
    "BRYANT PARK",
    "BRONX PARK",
    "POE PARK",
    "WAVE HILL",
    "CONFERENCE HOUSE PARK",
    "BROOKLYN BRIDGE PARK",
    "FORT TRYON PARK",
    "VAN CORTLANDT PARK",
    "PELHAM BAY PARK",
    "WILLIAMSBRIDGE OVAL",
    "ST. MARY'S PARK BRONX",
    "INWOOD HILL PARK"
  ),
  "ParkName" = c(
    "Flushing Meadows Corona Park",
    "Coney Island Beach",
    "Randall's Island",
    "Washington Square Park",
    "Prospect Park",
    "Riverside Park",
    "Union Square Park",
    "Crotona Park",
    "Bryant Park",
    "Bronx Park",
    "Poe Park",
    "Wave Hill",
    "Conference House Park",
    "Brooklyn Bridge Park",
    "Fort Tryon Park",
    "Van Cortlandt Park",
    "Pelham Bay Park",
    "Williamsbridge Oval Skate Park",
    "St. Maryâ€™s Park",
    "Inwood Hill Park"
  )
)

knitr::kable(
  park_crime_event_mapping,
  booktabs = TRUE,
  caption = 'Park in crime dataset to PkId in events dataset mapping to investigate'
)
```


We understand the limitations of picking only the parks with most crimes or most events or most diverse, however, 
it is very difficult for us to include parks with fewer events or crimes and link them from the two data sources, 
for many reasons, some of which were outlined in previous [Missing values] chapter (that 20% of our event listing 
data are missing `PkId`), and the [Most Diversified Park] section (that the same `PkId` includes many sub-areas 
of parks, so that for smaller or less popular parks, it is super difficult for us to map the names across the two 
datasets we have). Nevertheless, we still wanted to derive certain features of these parks and see what are some 
interesting patterns we can find. 

```{r}

interesting_park_crimes_mapped <- park_crime_event_mapping %>%
  merge(
    y = nyc_parks_crime, 
    by = "Park", 
    all.x = TRUE) %>%
  group_by(ParkName, Boro, Size) %>%
  summarize(ViolentCrm = sum(Mdr) + sum(Rape) + sum(Rob) + sum(Ass), 
            PropertyCrm = sum(Burg) + sum(G_L) + sum(GL_M_V),
            TotCrm = sum(Tot))

interesting_parks_events_mapped_summary <- nyc_event_listing_events %>%
  merge(
    y = nyc_event_listing_locations, 
    by = "EvtId", 
    all.x = TRUE) %>%
  drop_na(PkId) %>%
  merge(
    y = park_crime_event_mapping, 
    by = "PkId", 
    all.y = TRUE) %>%
  mutate(Duration=difftime(
    strptime(paste(Dt, ET), "%Y-%m-%d %H:%M"), strptime(paste(Dt, ST), "%Y-%m-%d %H:%M"), units = "hours")) %>%
  filter(Duration > 0) %>%
  .[c("PkId", "EvtId", "Duration", "CsFr", "Park", "ParkName")] %>%
  group_by(ParkName) %>%
  summarize(EvtCnt = n(), AvgDur = sum(Duration)/n(), FrRatio = sum(CsFr)/n())


parks_events_crime_relation_tidy <- parks_pkid_diversity %>%
  merge(
    y = park_crime_event_mapping, 
    by = "PkId", 
    all.y = TRUE) %>%
  .[c("UniqueCats", "UniqueOrgs", "ParkName")] %>%
  merge(
    y = interesting_parks_events_mapped_summary,
    by = "ParkName"
  ) %>%
  merge(
    y = interesting_park_crimes_mapped,
    by = "ParkName"
  )


parks_events_crime_relation_tidy <- parks_events_crime_relation_tidy[, c(2:6, 8:11)]

```

```{r}

parks_events_crime_relation_tidy <- parks_events_crime_relation_tidy[, c(1, 2, 6, 3, 9, 7:9, 4:5)]

ggparcoord(parks_events_crime_relation_tidy, 
           columns = 1:10, 
           scale = "std", 
           alphaLines = 1 / 3, 
           splineFactor = 10) +
  geom_vline(xintercept = 1:10, color = "lightblue") +
  ggtitle("") +
  labs(x = "Feature", y = "Univariately Std Re-Scaled Ratio")
```


* We can still observe the "diverse" correlation in terms of categories and organizers.
* More events actually mean fewer crimes
* Longer average duration actually mean fewer crimes
* Free events ratio and average duration relationship


## Spatial Analysis

### Cost

From the missing values chapter, we do not have missing data for `CsFr`, `Lat`, `Long`

TODO analyze weekends vs weekdays

```{r}
nyc_events_fee_location <- nyc_event_listing_events[c("EvtId", "CsFr", "Dt")] %>%
  merge(
    y = nyc_event_listing_locations, 
    by = "EvtId", 
    all.x = TRUE) %>% 
  .[c("EvtId", "CsFr", "Lat", "Long", "Dt")] %>%
  filter(year(.$Dt) == 2018) %>%
  filter(wday(Dt) == 7)
  #group_by(CsFr, Lat, Long) %>%
  #summarize(count = n()) %>%
  #ungroup()

# qmplot(Long, Lat, data = test, maptype = "toner-lite", color = I("red"))
```


TODO Too much data for this, select a year maybe

```{r}
cost_palette <- colorFactor(palette='RdBu', domain=nyc_events_fee_location$CsFr)

leaflet(nyc_events_fee_location) %>%
  addTiles() %>%
  setView(-74.00, 40.71, zoom = 10) %>%
  addCircleMarkers(~Long, ~Lat, radius = 5, stroke=FALSE, fillOpacity = 0.5, fillColor = ~ cost_palette(CsFr)) %>%
  addLegend("topright", pal = cost_palette, values = nyc_events_fee_location$CsFr, title = "Is Free")
```



### By Category

```{r}

test_cats <- c("Waterfront", "Games", "Festivals")

top_category_events_locations <- nyc_event_listing_events[c("EvtId")] %>%
  merge(
    y = nyc_event_categories, 
    by = "EvtId", 
    all.x = TRUE) %>%
  merge(
    y = nyc_event_listing_locations, 
    by = "EvtId", 
    all.x = TRUE) %>% 
  .[c("EvtId", "Cat", "Lat", "Long")] %>%
  filter(Cat %in% test_cats)
  #filter(Cat %in% top_categories$Cat)

categories_palette <- colorFactor(palette='Set1', domain=top_category_events_locations$Cat)
  
leaflet(top_category_events_locations) %>%
  addTiles() %>%
  setView(-74.00, 40.71, zoom = 10) %>%
  addCircleMarkers(~Long, ~Lat, radius = 5, stroke=FALSE, fillOpacity = 0.5, fillColor = ~ categories_palette(Cat)) %>%
  addLegend("topright", pal = categories_palette, values = top_category_events_locations$Cat, title = "Category")
```


### By Organizer


```{r}
top_organizers <- nyc_event_organizers %>%
  group_by(Org) %>%
  summarize(count = n()) %>%
  arrange(desc(count)) %>%
  top_n(8)

top_orgs_events_locations <- nyc_event_listing_events[c("EvtId")] %>%
  merge(
    y = nyc_event_organizers, 
    by = "EvtId", 
    all.x = TRUE) %>%
  merge(
    y = nyc_event_listing_locations, 
    by = "EvtId", 
    all.x = TRUE) %>% 
  .[c("EvtId", "Org", "Lat", "Long")] %>%
  filter(Org %in% top_organizers$Org)

organizers_palette <- colorFactor(palette='Set1', domain=top_orgs_events_locations$Org)
  
leaflet(top_orgs_events_locations) %>%
  addTiles() %>%
  setView(-74.00, 40.71, zoom = 10) %>%
  addCircleMarkers(~Long, ~Lat, radius = 5, stroke=FALSE, fillOpacity = 0.5, fillColor = ~ organizers_palette(Org)) %>%
  addLegend("topright", pal = organizers_palette, values = top_orgs_events_locations$Org, title = "Organizer")
```


## References

D. Kahle and H. Wickham. ggmap: Spatial Visualization with ggplot2. The R Journal, 5(1), 144-161. URL
  http://journal.r-project.org/archive/2013-1/kahle-wickham.pdf

