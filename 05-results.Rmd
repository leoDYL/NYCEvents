# Results

```{r}
library(ggmap)
library(tidyverse)
library(leaflet)
library(lubridate)
```


## Events and Parks Analysis

### Top Event Categories, Organizers, and Locations

We first take a look at what are the top event categories, organizers, and parks locations

```{r}
top_categories <- nyc_event_categories %>%
  group_by(Cat) %>%
  summarize(count = n()) %>%
  arrange(desc(count)) %>%
  top_n(30)

top_categories_levels <- levels(fct_reorder(top_categories$Cat, top_categories$count))

ggplot(top_categories, aes(x = count, y = fct_reorder(Cat, count))) +
  geom_point(color = "blue") +
  ggtitle("Top Event Categories") +
  labs(x = "Number of events", y = "Event Category") +
  theme_linedraw()

```

```{r}

top_organizers <- nyc_event_organizers %>%
  group_by(Org) %>%
  summarize(count = n()) %>%
  arrange(desc(count)) %>%
  top_n(30)

ggplot(top_organizers, aes(x = count, y = fct_reorder(Org, count))) +
  geom_point(color = "blue") +
  ggtitle("Top Event Organizers") +
  labs(x = "Number of events", y = "Event Organizer") +
  theme_linedraw()

```

```{r}

top_locations <- nyc_event_listing_locations %>%
  group_by(LcNm) %>%
  summarize(count = n()) %>%
  arrange(desc(count)) %>%
  top_n(30)

ggplot(top_locations, aes(x = count, y = fct_reorder(LcNm, count))) +
  geom_point(color = "blue") +
  ggtitle("Top Event Locations") +
  labs(x = "Number of events", y = "Event Location") +
  theme_linedraw()

```

### Most lively parks
```{r}
nyc_events_joined %>%
  drop_na(EvtId, Lat, Long) %>%
  mutate(gps_location=paste(Lat,Long, sep=",")) %>%
  group_by(gps_location) %>%
  summarise(num_events=n()) %>%
  arrange(desc(num_events)) %>%
  top_n(10) %>%
  ggplot(aes(x = num_events, y = fct_reorder(gps_location, num_events))) +
  geom_point(color = "blue") +
  ggtitle("Most lively parks") +
  labs(x = "Number of events", y = "Park Location") +
  theme_linedraw()
```

### Most Diversified Park
```{r}
nyc_events_joined %>%
  drop_na(EvtId, Lat, Long, Cat) %>%
  mutate(gps_location=paste(Lat,Long, sep=",")) %>%
  group_by(gps_location) %>%
  summarise(num_cats=length(unique(Cat))) %>%
  arrange(desc(num_cats)) %>%
  top_n(10) %>%
  ggplot(aes(x = num_cats, y = fct_reorder(gps_location, num_cats))) +
  geom_point(color = "blue") +
  ggtitle("Most diversified parks") +
  labs(x = "Number of event categories", y = "Park Location") +
  theme_linedraw()
```

### Ratio of free events in parks
```{r}
nyc_events_joined %>%
  drop_na(EvtId, Lat, Long, CsFr) %>%
  mutate(gps_location=paste(Lat,Long, sep=",")) %>%
  group_by(gps_location) %>%
  #filter(n() > 100) %>%
  summarise(free_ratio=sum(CsFr)/n()) %>%
  ggplot(aes(free_ratio)) +
  geom_histogram(color = "blue", fill = "lightblue", binwidth=0.1) +
  ggtitle("Histogram of free event ratio")
```



## Timeseries Analysis

Now, it is natural to think that there is some seasonality in the events that happen in the NYC public locations.
Here we are going to perform an analysis on what are some interesting seasonal patterns

### Timeseries Analysis on NYC Parks Events

First, we simply take an overview look at the count of listed events over time:

```{r}
nyc_events_timeseries <- nyc_event_listing_events %>%
  group_by(Dt) %>%
  summarize(Count = n()) %>%
  ungroup()

ggplot(nyc_events_timeseries, aes(Dt, Count)) + 
  geom_line() + 
  labs(x = "Date", y = "Count of Events") +
  ggtitle("Count of NYC Events in Parks Over Time")
```

Here, we observe a few things at first sight:

* The data counts appears to be abnormally low after the start of 2019, probably due to limited data availablility in the dataset, therefore, we are going to only use data prior to 2019 in our following timeseries analysis on the events daata in this section.
* The seasonality pattern looks similar for each year.
* There is definitely fewer events in winters around Janurary and generally more events in the summers.

The previous plot, although helps us identify the general pattern, looks pretty noisy, so next let's take a different view, which is less noisy:

```{r}
nyc_events_timeseries_monthly <- nyc_event_listing_events %>%
  filter(Dt < as.Date("2019-01-01")) %>%
  mutate(Year = year(Dt), Month = month(Dt, label = TRUE, abbr = TRUE)) %>%
  group_by(Year, Month) %>%
  summarize(Count = n())

ggplot(nyc_events_timeseries_monthly, aes(Month, Count)) +
  geom_col() +
  facet_grid(Year~.)+
  ggtitle("Monthly Count of NYC Events in Parks")
```

Here, we are aggregating the event counts by month, and plotted bar charts faceted by year. It is very clear from 
these charts that the monthly counts and trends do indeed have a very similar pattern across the years 2013-2018. 
Other than some fluctuations, January through March are typically the more quiet months with fewer than 500 events
in most years, then the number of events gradually increases in April, May and June, and peaks in July or August 
with more than 1500 events, and then gradually decreases into the winter season, with around 500 events in 
December.

Now, how about different days of week? It's certainly natural to speculate that there will be more events over 
weekends than during weekdays. Here, since we have concluded in the previous section that the seasonal trend is 
similar across the years, we take a closer look at the number of listed events by day of week in 2017 
to get an idea.

```{r}
nyc_events_timeseries %>%
  filter(year(Dt) == "2017") %>%
  ggplot(aes(Dt, Count)) +
  geom_line(color = "grey30") + 
  geom_point(size = 1) +
  scale_x_date(date_labels = "%b",
               date_breaks = "3 months") +
  facet_grid(.~wday(Dt, label = TRUE)) + 
  labs(x = "Date", y = "Count of Events") +
  ggtitle("Count of NYC Events in Parks By Day of Week in 2017") +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))
```

As expected, Saturdays do typically have a lot more events than the other days, especially during the summer 
season. It is somewhat surprising that Sundays only have about similar number of events as Tuesdays, Wednesdays 
and Thursdays. We speculate that for weekends, people prefer to stay at home with family and prepare for the new 
week on Sundays and prefer to go out to events on Saturdays, and therefore the event organizers have a preference 
to organize events on Saturdays. It is not surprising that Monday have the fewest events since people are 
typically busy on the first business day of the week. Fridays also appear to have the 2nd fewest number of events 
among the different days of week, as people wrap up the work for the week, and usually have corporate events or 
team bonding activities on Fridays.

### Timeseries Analysis on Event Categories

After the initial timeseries analysis, we feel that it's likely that other than the general seasonality and weekly
trends, different event sub-categories could have very different trends. Thus we will take a closer look at the top 30 categories for NYC parks events in this section.

```{r}
nyc_events_categories_timeseries_monthly <- nyc_event_listing_events %>%
  merge(
    y = nyc_event_categories, 
    by = "EvtId", 
    all.x = TRUE) %>%
  filter(Dt < as.Date("2019-01-01")) %>%
  filter(Cat %in% top_categories$Cat) %>%
  mutate(Year = year(Dt), 
         Month = month(Dt, label = TRUE, abbr = TRUE), 
         DoW = wday(Dt, label = TRUE),
         Cat = fct_rev(factor(Cat, levels = top_categories_levels)))
```

First, we look at if there are trends in the numbers of events for different categories over the years.


```{r, fig.height=9}

nyc_events_categories_timeseries_monthly %>%
  group_by(Year, Cat) %>%
  summarize(Count = n()) %>%
  ungroup() %>%
  ggplot(aes(Year, Count)) +
  geom_col() +
  facet_wrap(~Cat, ncol = 4) +
  ggtitle("Yearly Count of Events for top 30 Event Categories in NYC Parks") + 
  labs(x = "Year", y = "Count of Events") + 
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))
```


We can notice on this plot that for most of the top categories, the number of events listed in each year from 2013
to 2018 more or less just fluctuates and stays mostly flat. However, for category "Education", there is a very 
noticeable increase for year 2018, and for categories "Seniors", "Accessible", "Film", "Dance", "Free Summer 
Movies", there appear to be an uptrend, whereas for categories like "Games" and "Birding", there appear to be a 
downtrend.

Next, we look at if all categories follow the general seasonality discussed in the previous section, or there are 
noticeable differences in the different categories.


```{r, fig.height=9}
nyc_events_categories_timeseries_monthly %>%
  group_by(Month, Cat) %>%
  summarize(Count = n()) %>%
  ungroup() %>%
  ggplot(aes(Month, Count)) +
  geom_col() +
  scale_x_discrete(breaks=c("Mar", "Jun", "Sep", "Dec"),) + 
  facet_wrap(~Cat, ncol = 4) +
  ggtitle("Monthly Count of Events for top 30 Event Categories in NYC Parks") + 
  labs(x = "Month", y = "Count of Events") + 
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))
```


Here, we can see that yes, for most of the top 30 categories, they mostly follow the "more events in the summer, 
fewer in the winter" general rule, with some other interesting observations, most noticeably:

* "Nature" events appear to be relatively flat from April through October, which is Spring through Autumn for NYC, then reduces during winter.
* "Arts & Crafts", "Poe Park Visitor Center", "Urban Park Rangers", and "Talks" events look to be relatively flat and just fluctuates throughout the year, with no apparent peaks.
* "Volunteer", "It's My Park" and "City Parks Foundation" events appear to have peaks in May and October.
* "History", "Tours", and "Historic House Trust Sites" events appear to increase from Januray through October, peaks at October, and then decreases in November and December.
* "Birding" has peaks in April and May.

Lastly, we also inspect the day of week pattern of when the top 30 event categories happen.

```{r, fig.height=9}
nyc_events_categories_timeseries_monthly %>%
  group_by(DoW, Cat) %>%
  summarize(Count = n()) %>%
  ungroup() %>%
  ggplot(aes(DoW, Count)) +
  geom_col() +
  facet_wrap(~Cat, ncol = 4) +
  ggtitle("Day of Week Count of Events for top 30 Event Categories in NYC Parks") + 
  labs(x = "Day of Week", y = "Count of Events") + 
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))
```

As we can see from this plot, most of the top 30 event categories again follow the general "most events on Saturdays, fewest on Mondays" rule, again with some other interesting observations, most noticeably:

* "Seniors" has fewest events on Sundays and most events on Tuesdays, and relatively about the same count of events for different days of the week.
* "Volunteer", "It's My Park", "Urban Park Rangers", and "Birding" events happen primarily over weekends, and have very few events during weekdays.
* "Accessible", "Sports", and "Games" events happen about the same number of times during different days of the week.
* "Film" and "Free Summer Movies" have peaks on Fridays.
* "City Parks Foundation" events happen more frequently during weekdays than during weekends.
* "Poe Park Visitor Center" events do not occur on Sundays and Mondays.


## Spatial Analysis

### Cost

From the missing values chapter, we do not have missing data for `CsFr`, `Lat`, `Long`

TODO analyze weekends vs weekdays

```{r}
nyc_events_fee_location <- nyc_event_listing_events[c("EvtId", "CsFr", "Dt")] %>%
  merge(
    y = nyc_event_listing_locations, 
    by = "EvtId", 
    all.x = TRUE) %>% 
  .[c("EvtId", "CsFr", "Lat", "Long", "Dt")] %>%
  filter(year(.$Dt) == 2018) %>%
  filter(wday(Dt) == 7)
  #group_by(CsFr, Lat, Long) %>%
  #summarize(count = n()) %>%
  #ungroup()

# qmplot(Long, Lat, data = test, maptype = "toner-lite", color = I("red"))
```


TODO Too much data for this, select a year maybe

```{r}
cost_palette <- colorFactor(palette='RdBu', domain=nyc_events_fee_location$CsFr)

leaflet(nyc_events_fee_location) %>%
  addTiles() %>%
  setView(-74.00, 40.71, zoom = 10) %>%
  addCircleMarkers(~Long, ~Lat, radius = 5, stroke=FALSE, fillOpacity = 0.5, fillColor = ~ cost_palette(CsFr)) %>%
  addLegend("topright", pal = cost_palette, values = nyc_events_fee_location$CsFr, title = "Is Free")
```



### By Category

```{r}

test_cats <- c("Waterfront", "Games", "Festivals")

top_category_events_locations <- nyc_event_listing_events[c("EvtId")] %>%
  merge(
    y = nyc_event_categories, 
    by = "EvtId", 
    all.x = TRUE) %>%
  merge(
    y = nyc_event_listing_locations, 
    by = "EvtId", 
    all.x = TRUE) %>% 
  .[c("EvtId", "Cat", "Lat", "Long")] %>%
  filter(Cat %in% test_cats)
  #filter(Cat %in% top_categories$Cat)

categories_palette <- colorFactor(palette='Set1', domain=top_category_events_locations$Cat)
  
leaflet(top_category_events_locations) %>%
  addTiles() %>%
  setView(-74.00, 40.71, zoom = 10) %>%
  addCircleMarkers(~Long, ~Lat, radius = 5, stroke=FALSE, fillOpacity = 0.5, fillColor = ~ categories_palette(Cat)) %>%
  addLegend("topright", pal = categories_palette, values = top_category_events_locations$Cat, title = "Category")
```


### By Organizer


```{r}
top_organizers <- nyc_event_organizers %>%
  group_by(Org) %>%
  summarize(count = n()) %>%
  arrange(desc(count)) %>%
  top_n(8)

top_organizers

top_orgs_events_locations <- nyc_event_listing_events[c("EvtId")] %>%
  merge(
    y = nyc_event_organizers, 
    by = "EvtId", 
    all.x = TRUE) %>%
  merge(
    y = nyc_event_listing_locations, 
    by = "EvtId", 
    all.x = TRUE) %>% 
  .[c("EvtId", "Org", "Lat", "Long")] %>%
  filter(Org %in% top_organizers$Org)

organizers_palette <- colorFactor(palette='Set1', domain=top_orgs_events_locations$Org)
  
leaflet(top_orgs_events_locations) %>%
  addTiles() %>%
  setView(-74.00, 40.71, zoom = 10) %>%
  addCircleMarkers(~Long, ~Lat, radius = 5, stroke=FALSE, fillOpacity = 0.5, fillColor = ~ organizers_palette(Org)) %>%
  addLegend("topright", pal = organizers_palette, values = top_orgs_events_locations$Org, title = "Organizer")
```


## References

D. Kahle and H. Wickham. ggmap: Spatial Visualization with ggplot2. The R Journal, 5(1), 144-161. URL
  http://journal.r-project.org/archive/2013-1/kahle-wickham.pdf

