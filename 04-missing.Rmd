# Missing values

```{r}
library(tidyverse)
source("projectlibs/missing_value_plot.R")
```

## Missing Values By Individual Tables

We first analyze the missing values pattern for all of our tables individually.

### Missing Values for Main Events Listing Table

```{r nyc event listing events missing data}
missing_value_plot(nyc_event_listing_events, percent=FALSE)
colSums(is.na(nyc_event_listing_events)) %>% sort(decreasing = TRUE)
```

As shown in the graph above, the majority of the data points have missing fields. The most missed fields are "location_description" and "cost_description". 75% of the data points don't have those fields. We also have a lot of "Email" and "Phone" missings (around 25% and 20% respectively). 


### Missing Values for Auxiliary Tables

We also inspect the other auxiliary data tables that we are planning to use for our analysis.

```{r}
missing_value_plot(nyc_event_categories, percent = TRUE)
missing_value_plot(nyc_event_organizers, percent = TRUE)
colSums(is.na(nyc_event_organizers)) %>% sort(decreasing = TRUE)
```

As can be clearly seen from the missing data plots, the event category table itself does not have any missing data, and the event organizer table has very few missing organizer rows, more precisely, it only has 1 row of organizer missing.

The event id (`EvtId`) appears to be a unique identifier for events, and is always present in all rows of all tables we analyze.

How about the missing patterns when joining the individual additional information tables (categories, locations, and organizers) with the main events listing table? We will explore in the following section.


## Missing Values for Joined Data Table

Next, we analyze the missing value patterns when we join our main events listing table with the auxiliary tables.

### Using Full Outer Joins

As previously discussed, the location description (`LcDs`), cost description (`CsDs`), email (`Em`), phone (`Ph`),
snippet (`Snp`), description (`Ds`), url (`url`) are not interesting variables for the purpose of our project, as 
most of them are free-form text data, thus we are dropping them in this section for analyzing the missing patterns
for the events listing data joined with other additional information tablesm since we do not really care if they are missing or not. 

Also, as disccused previously, title
(`Title`), is cost free (`CsFr`), date (`Dt`), end time (`ET`), is must see (`MtSe`), notice (`Ntc`), start time
(`ST`) all have no missing data in the main events listing data table, we will only keep title (`Title`) to
represent these variables in this section.

As analyzed above, `Lat` / `Long` are always present in the locations table, thus we will use `Lat` to count the 
number of unique locations per `EvtId`, thus we used the following code snippet to prepare the data frame that we 
analyze the missing data patterns on, where `nyc_events_joined` is prepared with full outer joins.

```
nyc_events_joined[c("EvtId", "Title", "Lat", "Org", "Cat")] %>%
  group_by(EvtId) %>%
  summarize(
    Title = sum(!is.na(Title)),
    Org = sum(!is.na(Org)),
    Cat = sum(!is.na(Cat)),
    Loc = sum(!is.na(Lat))
  ) %>%
  mutate_all(na_if, 0) %>%
  ungroup()
```


```{r}
nyc_events_with_is_na <- nyc_events_joined[c("EvtId", "Title", "Lat", "Org", "Cat")] %>%
  group_by(EvtId) %>%
  summarize(
    Title = sum(!is.na(Title)),
    Org = sum(!is.na(Org)),
    Cat = sum(!is.na(Cat)),
    Loc = sum(!is.na(Lat))
  ) %>%
  mutate_all(na_if, 0) %>%
  ungroup()

missing_value_plot(nyc_events_with_is_na, percent = TRUE)
colSums(is.na(nyc_events_with_is_na)) %>% sort(decreasing = TRUE)
```


When only looking at these variables, almost 75% of the rows have complete information. 

There are roughly 15% cases from the joined dataset that have all of the event_id, organizer, category, and
location information, but missing the title (and thus the other variables information) only, meaning that there
are close to 15% of the events with an event_id that appear in all of the auxiliary tables but not the main event 
listing table. Therefore, if we performed left outer joins on the tables (where we keep the main event listing 
table on the left), we should be getting close to 90% of complete cases.

Also, roughly more than 20% of the cases are missing title, these are the events with event_id appear in at least one of the auxiliary tables but not in the main table.

It is also interesting to see that there are no cases of all organizer, category, location information missing but with title information present. So any listed events in the main dataset have at least one of the three information (organizer, category, location).

A potential explanation for the above facts might be that a placeholder event can be registered in the 
system with a minimum one of these three pieces of information and an event_id was generated, but the event
may or may not ultimately get listed and stored in the main event listing table.

### Using Left Outer Joins

The following plot demonstrates the missing pattern analysis when we instead perform left joins of the main table 
with the auxiliary tables. It confirms that we have close to 90% (from the plots, more than 87.5%) of complete 
cases among these variables, and the top missing variable is organizer (less than 12.5%), followed by category, 
followed by location information. 


```{r}
nyc_events_left_joined <- nyc_event_listing_events %>%
  merge(
    y = nyc_event_categories, 
    by = "EvtId", 
    all.x = TRUE) %>%
  merge(
    y = nyc_event_organizers, 
    by = "EvtId", 
    all.x = TRUE) %>%
  merge(
    y = nyc_event_locations, 
    by = "EvtId", 
    all.x = TRUE)

nyc_events_left_joined[c("EvtId", "Title", "Lat", "Org", "Cat")] %>%
  group_by(EvtId) %>%
  summarize(
    Title = sum(!is.na(Title)),
    Org = sum(!is.na(Org)),
    Cat = sum(!is.na(Cat)),
    Loc = sum(!is.na(Lat))
  ) %>%
  mutate_all(na_if, 0) %>%
  ungroup() %>%
  missing_value_plot(percent = TRUE)

```

As a result of the analysis in this section, we will use the table produced by the left outer join (including the 
variables that were left out in this section due to the `Title` representation) for our main 
analysis in later chapters, since it includes the most complete and interesting information.


## Top Categories with Missing Organizer

It is still pretty surprising to us that after the left outer join, we still have more than 10% of the cases 
missing an organizer, as we thought all events should have an organizer. Therefore, we wanted to see what are the top categories of events without the organizer information.

Note here that an event might be associated with multiple categories, so the total number of missing organizers 
across the different categories would be higher than the number of events with missing organizers in the previous 
section.


```{r}
nyc_events_left_joined %>%
  group_by(Cat) %>%
  summarize(Num_Missing_Org = sum(is.na(Org))) %>%
  ungroup() %>%
  arrange(desc(Num_Missing_Org)) %>%
  top_n(20) %>%
  ggplot(aes(x = Num_Missing_Org, y = fct_reorder(Cat, Num_Missing_Org))) + 
  geom_point(color = "blue") +
  ggtitle("Top event categories missing an organizer") +
  labs(x = "Number missing an organizer", y = "Event Category") +
  theme_linedraw() 
```

So it seems that sports-related events (with Fitness/Running/Sports/Outdoor Fitness categories) are the most common themes  for events missing organizer information in our dataset. A closer look at the specific event titles suggests that  a lot of them were running events organized by "NYRR" in different parks:

```{r}
nyc_events_left_joined %>%
  group_by(Title) %>%
  summarize(Num_Missing_Org = sum(is.na(Org))) %>%
  ungroup() %>%
  arrange(desc(Num_Missing_Org)) %>%
  top_n(20) %>%
  ggplot(aes(x = Num_Missing_Org, y = fct_reorder(Title, Num_Missing_Org))) + 
  geom_point(color = "blue") +
  ggtitle("Top event categories missing an organizer") +
  labs(x = "Number missing an organizer", y = "Event Title") +
  theme_linedraw() 
```


### Number of Missing By Date


## Missing Values for Crimes in Parks


```{r nyc park crimes missing data}
nyc_parks_crime <- read.csv("data/derived_data/nyc_parks_crime_data_all.csv", na.strings = "")

names(nyc_parks_crime) <- c(
  "Park", "Boro", "Size", "Cat", "Mdr", "Rape", "Rob", "Ass", "Burg", "G_L", "GL_M_V", "Tot", "Qtr"
)

crime_quarters <- c(
  "2021_q3",
  "2021_q2",
  "2021_q1",
  "2020_q4",
  "2020_q3",
  "2020_q2",
  "2020_q1",
  "2019_q4",
  "2019_q3",
  "2019_q2",
  "2019_q1",
  "2018_q4",
  "2018_q3",
  "2018_q2",
  "2018_q1",
  "2017_q4",
  "2017_q3",
  "2017_q2",
  "2017_q1",
  "2016_q4",
  "2016_q3",
  "2016_q2",
  "2016_q1",
  "2015_q4",
  "2015_q3",
  "2015_q2",
  "2015_q1",
  "2014_q4"
)

parks <- unique(nyc_parks_crime$Park)

park_qtr_missing_check <- data.frame(
  rep(parks, each = length(crime_quarters)), 
  rep(crime_quarters, times = length(parks))
  )
names(park_qtr_missing_check) <- c("Park", "Qtr")
nyc_parks_crime_complete_quarters <- merge(nyc_parks_crime, park_qtr_missing_check, by=c("Park", "Qtr"), all.y = TRUE) 

missing_value_plot(nyc_parks_crime, percent=TRUE)
col_missing = colSums(is.na(nyc_parks_crime)) %>% sort(decreasing = TRUE)
col_missing

missing_value_plot(nyc_parks_crime_complete_quarters, percent=TRUE)
col_missing = colSums(is.na(nyc_parks_crime_complete_quarters)) %>% sort(decreasing = TRUE)
col_missing
```
The NYC park crime data originally comes in different files by quarter. We consolidated all the files there are to analyze the missing data pattern. At the beginning, there are no missing data pattern found in the data set. However, after complementing all the quarters in the quarter column for each park, we notice that there are a small portion of the parks that do not have data for certain quarters. Since the number of those parks are minimal, we have the option to remove them from our future studies. 

